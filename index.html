<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¥åº·ç”Ÿæ´»ç´€éŒ„ Pro - å…¨åŠŸèƒ½ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        :root { --ios-bg: #F2F2F7; --ios-card: #FFFFFF; }
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: var(--ios-bg); 
            color: #1C1C1E; 
            -webkit-tap-highlight-color: transparent;
        }
        .ios-card { background: var(--ios-card); border-radius: 20px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03); margin-bottom: 16px; }
        .page { display: none; animation: fadeIn 0.2s ease-out; padding-bottom: 110px; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .nav-item.active { color: #4F46E5; }
        .portion-btn { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 10px; background: #F1F5F9; font-weight: bold; }
        .toggle-btn { padding: 8px 12px; border-radius: 12px; font-size: 13px; font-weight: 700; background: #F1F5F9; color: #64748B; transition: all 0.2s; border: none; flex: 1; text-align: center; }
        .toggle-btn.active { background: #4F46E5; color: white; box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3); }
        
        .photo-box { position: relative; aspect-ratio: 1/1; border-radius: 16px; border: 2px dashed #E2E8F0; background: #F8FAFC; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; cursor: pointer; transition: 0.2s; }
        .photo-box img { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; z-index: 10; }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { aspect-ratio: 1/1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 12px; font-size: 14px; position: relative; cursor: pointer; }
        .calendar-day.has-data::after { content: ''; position: absolute; bottom: 4px; width: 4px; height: 4px; background: #4F46E5; border-radius: 50%; }
        .calendar-day.selected { background: #4F46E5; color: white; font-weight: bold; }

        .status-tag { padding: 4px 8px; border-radius: 8px; font-size: 11px; font-weight: 700; background: #F1F5F9; color: #475569; display: flex; align-items: center; gap: 4px; border: 1px solid #E2E8F0; }
        .status-tag-green { background: #DCFCE7; color: #15803D; border-color: #BBF7D0; }
        .status-tag-red { background: #FEE2E2; color: #B91C1C; border-color: #FECACA; }
        
        .thumb-label { position: absolute; top: 4px; left: 4px; background: rgba(0,0,0,0.5); color: white; font-size: 8px; padding: 2px 4px; border-radius: 4px; z-index: 20; }
        
        input[type="range"] { accent-color: #4F46E5; }
    </style>
</head>
<body>

    <!-- é é¢ 1: æ¯æ—¥ç´€éŒ„ -->
    <div id="record-page" class="page active">
        <header class="p-6 pb-2 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-black text-slate-800">æ¯æ—¥ç´€éŒ„</h1>
                <p id="display-date" class="text-indigo-600 font-bold text-lg">è¼‰å…¥ä¸­...</p>
            </div>
            <button onclick="go('calendar')" class="bg-indigo-50 p-2 rounded-full text-indigo-600 active:scale-90 transition-transform">
                <i data-lucide="calendar-days"></i>
            </button>
        </header>

        <main class="px-4">
            <!-- 0. é«”é‡è…°åœ (ç½®é ‚) -->
            <div class="ios-card p-5">
                <h3 class="text-xs font-black text-slate-400 mb-3 uppercase tracking-widest">æ ¸å¿ƒæ•¸æ“š</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-slate-50 p-3 rounded-2xl border border-slate-100">
                        <label class="text-[10px] font-bold text-slate-500">é«”é‡ (kg)</label>
                        <input type="number" id="f-weight" step="0.1" placeholder="--" class="text-xl font-black w-full bg-transparent border-none p-0 focus:ring-0">
                    </div>
                    <div class="bg-slate-50 p-3 rounded-2xl border border-slate-100">
                        <label class="text-[10px] font-bold text-slate-500">è…°åœ (cm)</label>
                        <input type="number" id="f-waist" step="0.1" placeholder="--" class="text-xl font-black w-full bg-transparent border-none p-0 focus:ring-0">
                    </div>
                </div>
            </div>

            <!-- 1. é£²é£Ÿç…§ç‰‡ & ä»½é‡ -->
            <div class="ios-card p-5">
                <h3 class="text-xs font-black text-slate-400 mb-4 uppercase tracking-widest">1. é£²é£Ÿç´€éŒ„ (ä¸‰é¤ç…§ç‰‡èˆ‡ä»½é‡)</h3>
                <div class="grid grid-cols-4 gap-2 mb-4">
                    <div onclick="upImg('bk')" class="photo-box"><img id="img-bk" class="hidden"><i data-lucide="coffee" class="text-slate-300 w-5 h-5"></i><span class="text-[9px] text-slate-400 mt-1 text-center">æ—©é¤</span></div>
                    <div onclick="upImg('lu')" class="photo-box"><img id="img-lu" class="hidden"><i data-lucide="utensils" class="text-slate-300 w-5 h-5"></i><span class="text-[9px] text-slate-400 mt-1 text-center">åˆé¤</span></div>
                    <div onclick="upImg('dn')" class="photo-box"><img id="img-dn" class="hidden"><i data-lucide="moon" class="text-slate-300 w-5 h-5"></i><span class="text-[9px] text-slate-400 mt-1 text-center">æ™šé¤</span></div>
                    <div onclick="upImg('bd')" class="photo-box bg-indigo-50 border-indigo-100"><img id="img-bd" class="hidden"><i data-lucide="camera" class="text-indigo-300 w-5 h-5"></i><span class="text-[9px] text-indigo-400 mt-1 text-center">é«”æ…‹</span></div>
                </div>
                <input type="file" id="f-bk" accept="image/*" class="hidden" onchange="handleFile(this, 'img-bk')">
                <input type="file" id="f-lu" accept="image/*" class="hidden" onchange="handleFile(this, 'img-lu')">
                <input type="file" id="f-dn" accept="image/*" class="hidden" onchange="handleFile(this, 'img-dn')">
                <input type="file" id="f-bd" accept="image/*" class="hidden" onchange="handleFile(this, 'img-bd')">

                <div class="space-y-3">
                    <div class="flex items-center justify-between"><span class="text-sm font-bold">ğŸš ä¸»é£Ÿ (ç›®æ¨™ 2.5 ä»½)</span><div class="flex items-center gap-3"><button onclick="adjPortion('carbs',-0.5)" class="portion-btn">-</button><span id="v-carbs" class="font-black w-8 text-center text-indigo-600">0.0</span><button onclick="adjPortion('carbs',0.5)" class="portion-btn text-indigo-600">+</button></div></div>
                    <div class="flex items-center justify-between"><span class="text-sm font-bold">ğŸ— è›‹ç™½è³ª (ç›®æ¨™ 2.5 ä»½)</span><div class="flex items-center gap-3"><button onclick="adjPortion('prot',-0.5)" class="portion-btn">-</button><span id="v-prot" class="font-black w-8 text-center text-indigo-600">0.0</span><button onclick="adjPortion('prot',0.5)" class="portion-btn text-indigo-600">+</button></div></div>
                    <div class="flex items-center justify-between"><span class="text-sm font-bold">ğŸ¥¦ è”¬èœ (ç›®æ¨™ 3 ä»½)</span><div class="flex items-center gap-3"><button onclick="adjPortion('veg',-0.5)" class="portion-btn">-</button><span id="v-veg" class="font-black w-8 text-center text-indigo-600">0.0</span><button onclick="adjPortion('veg',0.5)" class="portion-btn text-indigo-600">+</button></div></div>
                </div>
            </div>

            <!-- 2. æ°´ -->
            <div class="ios-card p-5">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">2. é£²æ°´é‡ (cc)</h3>
                    <span id="display-water" class="text-sm font-black text-indigo-600">0 cc</span>
                </div>
                <div class="flex gap-2">
                    <button onclick="adjWater(250)" class="flex-1 bg-indigo-50 text-indigo-600 py-3 rounded-xl font-bold">+250</button>
                    <button onclick="adjWater(500)" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold">+500</button>
                    <button onclick="adjWater(-250)" class="bg-slate-100 text-slate-400 px-4 rounded-xl font-bold">-</button>
                </div>
                <input type="number" id="f-water" class="hidden" value="0">
            </div>

            <!-- 3-4. æŒ‘æˆ° -->
            <div class="ios-card p-5">
                <h3 class="text-xs font-black text-slate-400 mb-3 uppercase tracking-widest">3-4. é£²é£ŸæŒ‘æˆ°</h3>
                <div class="flex gap-2">
                    <button id="btn-evil" onclick="this.classList.toggle('active')" class="toggle-btn">3. é‚ªæƒ¡é£Ÿç‰©</button>
                    <button id="btn-party" onclick="this.classList.toggle('active')" class="toggle-btn">4. ç¤¾äº¤èšé¤</button>
                </div>
            </div>

            <!-- 5-10. ç”Ÿæ´»ç‹€æ…‹ -->
            <div class="ios-card p-5">
                <h3 class="text-xs font-black text-slate-400 mb-4 uppercase tracking-widest">ç”Ÿæ´»ç‹€æ…‹è‡ªæª¢ (5-10)</h3>
                <div class="space-y-4">
                    <div class="bg-indigo-50/50 p-4 rounded-2xl">
                        <label class="text-[10px] font-bold text-indigo-500 block mb-2">5. ç¡çœ æ™‚é–“</label>
                        <div class="flex items-center gap-2">
                            <input type="time" id="f-sleep-start" class="flex-1 bg-white rounded-lg p-2 text-xs font-bold border-none">
                            <span class="text-slate-400">è‡³</span>
                            <input type="time" id="f-sleep-end" class="flex-1 bg-white rounded-lg p-2 text-xs font-bold border-none">
                        </div>
                        <select id="f-sleep-quality" class="w-full mt-2 bg-white rounded-lg px-3 py-2 font-bold text-xs border-none">
                            <option value="è‰¯å¥½">ğŸ˜´ å“è³ªï¼šè‰¯å¥½</option>
                            <option value="æ™®é€š">ğŸ˜‘ å“è³ªï¼šæ™®é€š</option>
                            <option value="å·®">ğŸ˜« å“è³ªï¼šå·®/æ·ºçœ </option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[10px] font-bold text-slate-500">6. å£“åŠ›ç‹€æ³</label>
                            <select id="f-stress" class="w-full mt-1 bg-slate-50 rounded-xl px-3 py-3 font-bold text-xs border-none">
                                <option value="ä½">ğŸ˜Š ä½</option>
                                <option value="ä¸­">ğŸ˜ ä¸­</option>
                                <option value="é«˜">ğŸ”¥ é«˜</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-500">7. ç–²å‹ç‹€æ³</label>
                            <select id="f-fatigue" class="w-full mt-1 bg-slate-50 rounded-xl px-3 py-3 font-bold text-xs border-none">
                                <option value="æ´»åŠ›">âš¡ æ´»åŠ›</option>
                                <option value="ä¸€èˆ¬">ğŸš¶ ä¸€èˆ¬</option>
                                <option value="ç–²æ†Š">ğŸ¥± ç–²æ†Š</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-500">8. ä¾¿ä¾¿ç‹€æ³</label>
                            <select id="f-poop" class="w-full mt-1 bg-slate-50 rounded-xl px-3 py-3 font-bold text-xs border-none">
                                <option value="é †æš¢">ğŸŸ¢ é †æš¢</option>
                                <option value="ç¡¬ä¹¾">ğŸŸ¡ ç¡¬ä¹¾</option>
                                <option value="æœªæ’">ğŸ”´ æœªæ’ä¾¿</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-500">9. æ°´è…«ç‹€æ³</label>
                            <select id="f-edema" class="w-full mt-1 bg-slate-50 rounded-xl px-3 py-3 font-bold text-xs border-none">
                                <option value="ç„¡">ğŸ’§ ç„¡</option>
                                <option value="è¼•å¾®">ğŸ¤ è¼•å¾®</option>
                                <option value="åš´é‡">ğŸˆ åš´é‡</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-500">10. é£½è¶³æ„Ÿ (1-10)</label>
                        <div class="flex items-center gap-2 mt-2">
                            <input type="range" id="f-fullness" min="1" max="10" step="1" value="5" class="flex-1" oninput="document.getElementById('v-fullness').innerText=this.value">
                            <span id="v-fullness" class="text-sm font-black text-indigo-600 w-4">5</span>
                        </div>
                    </div>
                </div>
            </div>

            <button onclick="saveRecord()" id="save-btn" class="w-full bg-slate-900 text-white py-5 rounded-2xl font-black shadow-xl active:scale-95 transition-transform mb-4">å„²å­˜ä»Šæ—¥ç´€éŒ„</button>
        </main>
    </div>

    <!-- é é¢ 2: æ¯é€±æª¢è¦– -->
    <div id="weekly-page" class="page">
        <header class="p-6">
            <h1 class="text-2xl font-black text-slate-800">æ¯é€±æª¢è¦–</h1>
            <p id="weekly-range-label" class="text-indigo-600 font-bold text-sm uppercase tracking-wider"></p>
        </header>
        <main class="px-4">
            <div class="ios-card p-5">
                <h3 class="text-sm font-bold mb-4">æœ¬é€±é«”é‡è®ŠåŒ–</h3>
                <div class="h-40"><canvas id="weightChart"></canvas></div>
            </div>

            <div id="weekly-details" class="space-y-4 pb-10">
                <!-- æ¯æ—¥ç¸®åœ–æ‘˜è¦ -->
            </div>
        </main>
    </div>

    <!-- é é¢ 3: æœˆæ›† -->
    <div id="calendar-page" class="page">
        <header class="p-6">
            <h1 class="text-2xl font-black text-slate-800">æ­·ç¨‹å›é¡§</h1>
        </header>
        <main class="px-4">
            <div class="ios-card p-5">
                <div class="flex justify-between items-center mb-6">
                    <button onclick="changeMonth(-1)" class="p-2 text-slate-400"><i data-lucide="chevron-left"></i></button>
                    <h2 id="calendar-title" class="font-black text-lg">2024å¹´ 1æœˆ</h2>
                    <button onclick="changeMonth(1)" class="p-2 text-slate-400"><i data-lucide="chevron-right"></i></button>
                </div>
                <div class="grid grid-cols-7 text-center text-[10px] font-black text-slate-300 mb-4 uppercase">
                    <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                </div>
                <div id="calendar-body" class="calendar-grid"></div>
            </div>
        </main>
    </div>

    <!-- å°è¦½ -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-xl border-t border-slate-100 flex justify-around p-4 pb-8 z-[100]">
        <button onclick="go('record')" id="btn-record" class="nav-item active flex flex-col items-center gap-1">
            <i data-lucide="edit-3" class="w-6 h-6"></i><span class="text-[10px] font-black">ç´€éŒ„</span>
        </button>
        <button onclick="go('weekly')" id="btn-weekly" class="nav-item text-slate-300 flex flex-col items-center gap-1">
            <i data-lucide="bar-chart-2" class="w-6 h-6"></i><span class="text-[10px] font-black">é€±æª¢è¦–</span>
        </button>
        <button onclick="go('calendar')" id="btn-calendar" class="nav-item text-slate-300 flex flex-col items-center gap-1">
            <i data-lucide="calendar" class="w-6 h-6"></i><span class="text-[10px] font-black">æ­·ç¨‹</span>
        </button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'health-tracker-v4';

        let user = null;
        let allData = {}; 
        let currentDate = new Date(); 
        let calendarDate = new Date(); 

        window.onload = async () => {
            lucide.createIcons();
            const now = new Date();
            currentDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            updateDateLabel();
            
            await signInAnonymously(auth);
            onAuthStateChanged(auth, u => { if (u) { user = u; listenData(); } });

            setInterval(() => {
                const checkNow = new Date();
                if (checkNow.getDate() !== currentDate.getDate()) {
                    currentDate = new Date(checkNow.getFullYear(), checkNow.getMonth(), checkNow.getDate());
                    updateDateLabel();
                    loadData(formatDate(currentDate));
                }
            }, 60000);
        };

        function listenData() {
            if (!user) return;
            onSnapshot(query(collection(db, 'artifacts', appId, 'users', user.uid, 'dailyLogs')), (snap) => {
                allData = {};
                snap.forEach(doc => allData[doc.id] = doc.data());
                renderCalendar();
                loadData(formatDate(currentDate));
                if(document.getElementById('weekly-page').classList.contains('active')) renderWeekly();
            }, (err) => console.error(err));
        }

        window.upImg = (id) => document.getElementById(`f-${id}`).click();
        window.handleFile = (input, imgId) => {
            if (input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => {
                    const img = document.getElementById(imgId);
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                };
                reader.readAsDataURL(input.files[0]);
            }
        };

        window.adjPortion = (t, v) => {
            const el = document.getElementById(`v-${t}`);
            el.innerText = Math.max(0, parseFloat(el.innerText) + v).toFixed(1);
        };

        window.adjWater = (v) => {
            const el = document.getElementById('f-water');
            const disp = document.getElementById('display-water');
            el.value = Math.max(0, parseInt(el.value) + v);
            disp.innerText = `${el.value} cc`;
        };

        window.saveRecord = async () => {
            if (!user) return;
            const btn = document.getElementById('save-btn');
            const dateStr = formatDate(currentDate);
            btn.innerText = "åŒæ­¥æ•¸æ“šä¸­...";
            
            const data = {
                weight: parseFloat(document.getElementById('f-weight').value) || null,
                waist: parseFloat(document.getElementById('f-waist').value) || null,
                water: parseInt(document.getElementById('f-water').value),
                carbs: parseFloat(document.getElementById('v-carbs').innerText),
                prot: parseFloat(document.getElementById('v-prot').innerText),
                veg: parseFloat(document.getElementById('v-veg').innerText),
                evil: document.getElementById('btn-evil').classList.contains('active'),
                party: document.getElementById('btn-party').classList.contains('active'),
                sleepStart: document.getElementById('f-sleep-start').value,
                sleepEnd: document.getElementById('f-sleep-end').value,
                sleepQuality: document.getElementById('f-sleep-quality').value,
                stress: document.getElementById('f-stress').value,
                fatigue: document.getElementById('f-fatigue').value,
                poop: document.getElementById('f-poop').value,
                edema: document.getElementById('f-edema').value,
                fullness: parseInt(document.getElementById('f-fullness').value),
                imgBk: document.getElementById('img-bk').src || null,
                imgLu: document.getElementById('img-lu').src || null,
                imgDn: document.getElementById('img-dn').src || null,
                imgBd: document.getElementById('img-bd').src || null,
                updated: new Date().getTime()
            };

            await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'dailyLogs', dateStr), data);
            btn.innerText = "å·²æˆåŠŸå„²å­˜ âœ¨";
            setTimeout(() => btn.innerText = "å„²å­˜ä»Šæ—¥ç´€éŒ„", 2000);
        };

        function loadData(dateStr) {
            const data = allData[dateStr] || {};
            document.getElementById('f-weight').value = data.weight || "";
            document.getElementById('f-waist').value = data.waist || "";
            document.getElementById('f-water').value = data.water || 0;
            document.getElementById('display-water').innerText = `${data.water || 0} cc`;
            document.getElementById('v-carbs').innerText = (data.carbs || 0).toFixed(1);
            document.getElementById('v-prot').innerText = (data.prot || 0).toFixed(1);
            document.getElementById('v-veg').innerText = (data.veg || 0).toFixed(1);
            document.getElementById('f-sleep-start').value = data.sleepStart || "";
            document.getElementById('f-sleep-end').value = data.sleepEnd || "";
            document.getElementById('f-sleep-quality').value = data.sleepQuality || "è‰¯å¥½";
            document.getElementById('f-fullness').value = data.fullness || 5;
            document.getElementById('v-fullness').innerText = data.fullness || 5;
            ['stress', 'fatigue', 'poop', 'edema'].forEach(id => {
                document.getElementById(`f-${id}`).value = data[id] || document.getElementById(`f-${id}`).options[0].value;
            });
            ['evil', 'party'].forEach(id => {
                if(data[id]) document.getElementById(`btn-${id}`).classList.add('active');
                else document.getElementById(`btn-${id}`).classList.remove('active');
            });
            ['bk', 'lu', 'dn', 'bd'].forEach(id => {
                const img = document.getElementById(`img-${id}`);
                const dataKey = `img${id.charAt(0).toUpperCase() + id.slice(1)}`;
                if(data[dataKey] && data[dataKey].startsWith('data:image')) {
                    img.src = data[dataKey];
                    img.classList.remove('hidden');
                } else {
                    img.src = "";
                    img.classList.add('hidden');
                }
            });
        }

        window.go = (p) => {
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => { el.classList.add('text-slate-300'); el.classList.remove('active'); });
            document.getElementById(`${p}-page`).classList.add('active');
            document.getElementById(`btn-${p}`).classList.add('active');
            document.getElementById(`btn-${p}`).classList.remove('text-slate-300');
            if(p === 'weekly') renderWeekly();
            if(p === 'calendar') renderCalendar();
            lucide.createIcons();
        };

        function renderWeekly() {
            const container = document.getElementById('weekly-details');
            container.innerHTML = "";
            
            // ç²å–æœ¬é€±ä¸€åˆ°é€±æ—¥
            const curr = new Date();
            const day = curr.getDay(); // 0 æ˜¯é€±æ—¥, 1-6 æ˜¯é€±ä¸€åˆ°é€±å…­
            const diff = curr.getDate() - day + (day === 0 ? -6 : 1); // èª¿æ•´è‡³æœ¬é€±ä¸€
            const monday = new Date(curr.setDate(diff));
            
            const weekDates = [];
            for(let i=0; i<7; i++) {
                const d = new Date(monday);
                d.setDate(monday.getDate() + i);
                weekDates.push(formatDate(d));
            }
            document.getElementById('weekly-range-label').innerText = `æœ¬é€±ï¼š${weekDates[0]} ~ ${weekDates[6]}`;

            weekDates.forEach(date => {
                const data = allData[date] || null;
                const dObj = new Date(date);
                const dayName = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][dObj.getDay()];
                const dateLabel = `${dObj.getMonth()+1}/${dObj.getDate()} (${dayName})`;
                
                const card = document.createElement('div');
                card.className = "ios-card p-4";
                if(!data) {
                    card.innerHTML = `<div class="flex justify-between items-center opacity-40"><span class="font-bold text-slate-400">${dateLabel}</span><span class="text-[10px] italic">å°šæœªå¡«å¯«ç´€éŒ„</span></div>`;
                } else {
                    const statusClass = (val, bad) => val === bad ? 'status-tag-red' : (['è‰¯å¥½','æ´»åŠ›','é †æš¢','ç„¡','ä½'].includes(val) ? 'status-tag-green' : 'status-tag');
                    
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <span class="font-black text-slate-900 text-lg">${dateLabel}</span>
                                <div class="flex gap-2 mt-1">
                                    <span class="bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded text-[10px] font-bold">âš–ï¸ ${data.weight || '--'}kg</span>
                                    <span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-[10px] font-bold">ğŸ“ ${data.waist || '--'}cm</span>
                                </div>
                            </div>
                            <div class="flex gap-1">
                                ${data.evil ? '<span class="bg-red-500 text-white w-6 h-6 flex items-center justify-center rounded-lg text-xs">ğŸ•</span>' : ''}
                                ${data.party ? '<span class="bg-orange-500 text-white w-6 h-6 flex items-center justify-center rounded-lg text-xs">ğŸ»</span>' : ''}
                            </div>
                        </div>

                        <!-- é£²é£Ÿç¸®åœ– (å·¦ä¸Šè§’å‚™è¨») -->
                        <div class="grid grid-cols-4 gap-2 mb-4">
                            ${[
                                {k:'imgBk', t:'æ—©'}, {k:'imgLu', t:'ä¸­'}, {k:'imgDn', t:'æ™š'}, {k:'imgBd', t:'é«”'}
                            ].map(item => `
                                <div class="relative aspect-square border border-slate-100 rounded-xl overflow-hidden shadow-sm bg-slate-50">
                                    <span class="thumb-label">${item.t}</span>
                                    ${data[item.k] ? `<img src="${data[item.k]}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-[10px] text-slate-300">ç„¡</div>`}
                                </div>
                            `).join('')}
                        </div>

                        <!-- è‡ªæª¢è¡¨ç¶²æ ¼æ’ç‰ˆ -->
                        <div class="grid grid-cols-3 gap-2">
                            <div class="status-tag ${data.carbs >= 2.5 ? 'status-tag-green' : ''}">ğŸš ä¸»:${data.carbs}</div>
                            <div class="status-tag ${data.prot >= 2.5 ? 'status-tag-green' : ''}">ğŸ— è›‹:${data.prot}</div>
                            <div class="status-tag ${data.veg >= 3 ? 'status-tag-green' : ''}">ğŸ¥¦ è”¬:${data.veg}</div>
                            <div class="status-tag">ğŸ’§ ${data.water}cc</div>
                            <div class="status-tag ${statusClass(data.sleepQuality, 'å·®')}">ğŸ˜´ ${data.sleepQuality}</div>
                            <div class="status-tag">â° ${data.sleepStart || '--'}-${data.sleepEnd || '--'}</div>
                            <div class="status-tag ${statusClass(data.stress, 'é«˜')}">ğŸ”¥ å£“:${data.stress}</div>
                            <div class="status-tag ${statusClass(data.fatigue, 'ç–²æ†Š')}">ğŸ¥± ${data.fatigue}</div>
                            <div class="status-tag ${statusClass(data.poop, 'æœªæ’')}">ğŸ’© ${data.poop}</div>
                            <div class="status-tag ${statusClass(data.edema, 'åš´é‡')}">ğŸˆ è…«:${data.edema}</div>
                            <div class="status-tag col-span-2">ğŸ˜‹ é£½è¶³æ„Ÿ: ${data.fullness}/10</div>
                        </div>
                    `;
                    card.onclick = () => { currentDate = new Date(date); updateDateLabel(); go('record'); };
                }
                container.appendChild(card);
            });
            updateChart(weekDates);
        }

        let weightChart = null;
        function updateChart(dates) {
            const ctx = document.getElementById('weightChart').getContext('2d');
            const dataPoints = dates.map(d => allData[d]?.weight || null);
            if(weightChart) weightChart.destroy();
            weightChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates.map(d => d.split('-')[2]),
                    datasets: [{ 
                        data: dataPoints, 
                        borderColor: '#4F46E5', 
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        fill: true,
                        tension: 0.4, 
                        pointRadius: 4,
                        pointBackgroundColor: '#4F46E5',
                        spanGaps: true 
                    }]
                },
                options: { 
                    plugins: { legend: { display: false } }, 
                    scales: { y: { beginAtZero: false, grid: { color: '#F8FAFC' } }, x: { grid: { display: false } } }, 
                    maintainAspectRatio: false 
                }
            });
        }

        window.changeMonth = (v) => { calendarDate.setMonth(calendarDate.getMonth() + v); renderCalendar(); };
        function renderCalendar() {
            const body = document.getElementById('calendar-body');
            const title = document.getElementById('calendar-title');
            body.innerHTML = '';
            const y = calendarDate.getFullYear(), m = calendarDate.getMonth();
            title.innerText = `${y}å¹´ ${m + 1}æœˆ`;
            const first = new Date(y, m, 1).getDay(), last = new Date(y, m + 1, 0).getDate();
            for(let i=0; i<first; i++) body.innerHTML += '<div></div>';
            for(let d=1; d<=last; d++) {
                const ds = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const has = allData[ds], sel = ds === formatDate(currentDate);
                const el = document.createElement('div');
                el.className = `calendar-day ${has ? 'has-data' : ''} ${sel ? 'selected' : ''}`;
                el.innerText = d;
                el.onclick = () => { currentDate = new Date(y, m, d); updateDateLabel(); go('record'); };
                body.appendChild(el);
            }
        }

        function formatDate(d) { 
            const offset = d.getTimezoneOffset();
            const localDate = new Date(d.getTime() - (offset * 60 * 1000));
            return localDate.toISOString().split('T')[0]; 
        }
        function updateDateLabel() { 
            document.getElementById('display-date').innerText = currentDate.toLocaleDateString('zh-TW', { month:'long', day:'numeric', weekday:'long'}); 
        }
    </script>
</body>
</html>
